<!-- templates/core/painel.html -->
{% extends 'base.html' %}

{% block title %}Painel - BaixaFy{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- User Status Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="music-card p-4">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h2 class="h3 fw-bold mb-2">
                            Olá, {{ user.first_name|default:user.username }}! 
                            <i class="fas fa-wave-square text-spotify"></i>
                        </h2>
                        
                        {% if is_premium %}
                            <p class="mb-0 text-spotify">
                                <i class="fas fa-crown me-2"></i>
                                <strong>Conta Premium Ativa</strong> - {{ days_remaining }} dias restantes
                            </p>
                        {% else %}
                            <p class="mb-0 text-muted">
                                <i class="fas fa-user me-2"></i>
                                Conta Gratuita - 
                                {% if can_download %}
                                    <span class="text-spotify">{{ free_downloads_used }}/1 downloads gratuitos usados</span>
                                {% else %}
                                    <span class="text-warning">Limite de downloads atingido</span>
                                {% endif %}
                            </p>
                        {% endif %}
                    </div>
                    
                    <div class="col-lg-4 text-lg-end">
                        {% if not is_premium %}
                            <a href="{% url 'pagamento' %}" class="btn btn-spotify">
                                <i class="fas fa-crown me-2"></i>Assinar Premium
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Download Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="music-card p-4">
                <h4 class="fw-bold mb-4">
                    <i class="fas fa-download me-2 text-spotify"></i>
                    Baixar Música ou Playlist
                </h4>
                
                <form id="download-form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-lg-9">
                            <div class="mb-3">
                                <label for="spotify-url" class="form-label fw-bold">
                                    Cole o link do Spotify aqui:
                                </label>
                                <input 
                                    type="url" 
                                    class="form-control form-control-lg" 
                                    id="spotify-url" 
                                    placeholder="https://open.spotify.com/track/..." 
                                    required
                                >
                                <div class="form-text text-muted">
                                    Suportamos links de músicas, playlists e álbuns do Spotify
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3">
                            <label class="form-label d-block">&nbsp;</label>
                            <button type="submit" class="btn btn-spotify btn-lg w-100" id="preview-btn">
                                <i class="fas fa-search me-2"></i>Visualizar
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Loading Spinner -->
                <div id="loading-spinner" class="text-center py-4 d-none">
                    <div class="spinner-border text-spotify" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Obtendo informações da música...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Music Preview Section -->
    <div id="music-preview" class="row mb-4 d-none">
        <div class="col-12">
            <div class="music-card p-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-eye me-2 text-spotify"></i>
                    Prévia do Conteúdo
                </h5>
                
                <div id="preview-content">
                    <!-- Content will be loaded here via JavaScript -->
                </div>
                
                <div class="text-center mt-4">
                    <button id="download-btn" class="btn btn-spotify btn-lg" disabled>
                        <i class="fas fa-download me-2"></i>Baixar Agora
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Download Results -->
    <div id="download-results" class="row mb-4 d-none">
        <div class="col-12">
            <div class="music-card p-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    Resultado do Download
                </h5>
                
                <div id="results-content">
                    <!-- Results will be loaded here via JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="music-card p-4 text-center">
                <div class="h2 fw-bold text-spotify">{{ total_downloads }}</div>
                <small class="text-muted">Total de Downloads</small>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="music-card p-4 text-center">
                <div class="h2 fw-bold text-spotify">
                    {% if is_premium %}∞{% else %}{{ free_downloads_used }}/1{% endif %}
                </div>
                <small class="text-muted">Downloads Disponíveis</small>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="music-card p-4 text-center">
                <div class="h2 fw-bold text-spotify">
                    {% if is_premium %}{{ days_remaining }}{% else %}0{% endif %}
                </div>
                <small class="text-muted">Dias Premium</small>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="music-card p-4 text-center">
                <div class="h2 fw-bold text-spotify">MP3</div>
                <small class="text-muted">Formato de Áudio</small>
            </div>
        </div>
    </div>
    
    <!-- Recent Downloads -->
    {% if recent_downloads %}
    <div class="row">
        <div class="col-12">
            <div class="music-card p-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-history me-2 text-spotify"></i>
                    Downloads Recentes
                </h5>
                
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Música</th>
                                <th>Artista</th>
                                <th>Data</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for download in recent_downloads %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ download.song_title }}</div>
                                    {% if download.album_name %}
                                    <small class="text-muted">{{ download.album_name }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ download.artist_name }}</td>
                                <td>
                                    <small>{{ download.download_date|date:"d/m/Y H:i" }}</small>
                                </td>
                                <td>
                                    {% if download.file_path %}
                                    <a href="{% url 'download_file' %}?file={{ download.file_path|split:'/'|last }}" 
                                       class="btn btn-sm btn-outline-spotify">
                                        <i class="fas fa-download me-1"></i>Baixar
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center mt-3">
                    <a href="{% url 'historico' %}" class="btn btn-outline-light">
                        <i class="fas fa-history me-2"></i>Ver Histórico Completo
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentSpotifyUrl = '';
    
    // Handle form submission for preview
    $('#download-form').on('submit', function(e) {
        e.preventDefault();
        
        const spotifyUrl = $('#spotify-url').val().trim();
        
        if (!spotifyUrl) {
            alert('Por favor, cole um link do Spotify');
            return;
        }
        
        currentSpotifyUrl = spotifyUrl;
        getSpotifyInfo(spotifyUrl);
    });
    
    // Get Spotify info via AJAX
    function getSpotifyInfo(url) {
        $('#loading-spinner').removeClass('d-none');
        $('#music-preview').addClass('d-none');
        $('#download-results').addClass('d-none');
        
        $.ajax({
            url: '{% url "spotify_info" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ spotify_url: url }),
            success: function(response) {
                $('#loading-spinner').addClass('d-none');
                displayPreview(response);
            },
            error: function(xhr) {
                $('#loading-spinner').addClass('d-none');
                const error = JSON.parse(xhr.responseText);
                alert('Erro: ' + error.error);
            }
        });
    }
    
    // Display preview content
    function displayPreview(data) {
        let html = '';
        
        if (data.type === 'track') {
            const track = data.data;
            html = `
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <img src="${track.cover_url}" class="img-fluid rounded" alt="Capa do álbum">
                    </div>
                    <div class="col-md-9">
                        <h5 class="fw-bold">${track.title}</h5>
                        <p class="text-muted mb-1">Por: ${track.artist}</p>
                        <p class="text-muted mb-1">Álbum: ${track.album}</p>
                        <p class="text-muted mb-1">Duração: ${track.duration}</p>
                        <p class="text-muted">Ano: ${track.year}</p>
                    </div>
                </div>
            `;
        } else if (data.type === 'playlist') {
            const playlist = data.data;
            html = `
                <div class="mb-3">
                    <h5 class="fw-bold">Playlist com ${playlist.total_tracks} músicas</h5>
                </div>
                <div class="row">
            `;
            
            playlist.tracks.slice(0, 6).forEach((track, index) => {
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="d-flex align-items-center">
                            <img src="${track.cover_url}" class="rounded me-3" width="60" height="60" alt="Capa">
                            <div>
                                <div class="fw-bold small">${track.title}</div>
                                <div class="text-muted small">${track.artist}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (playlist.total_tracks > 6) {
                html += `
                    <div class="col-12">
                        <p class="text-center text-muted">... e mais ${playlist.total_tracks - 6} músicas</p>
                    </div>
                `;
            }
            
            html += '</div>';
        }
        
        $('#preview-content').html(html);
        $('#music-preview').removeClass('d-none');
        $('#download-btn').prop('disabled', false);
    }
    
    // Handle download button click
    $('#download-btn').on('click', function() {
        if (!currentSpotifyUrl) return;
        
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Baixando...');
        
        $.ajax({
            url: '{% url "download_music" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ spotify_url: currentSpotifyUrl }),
            success: function(response) {
                $('#download-btn').prop('disabled', false).html('<i class="fas fa-download me-2"></i>Baixar Agora');
                displayResults(response);
            },
            error: function(xhr) {
                $('#download-btn').prop('disabled', false).html('<i class="fas fa-download me-2"></i>Baixar Agora');
                const error = JSON.parse(xhr.responseText);
                
                if (error.needs_subscription) {
                    if (confirm(error.error + ' Deseja assinar o plano premium?')) {
                        window.location.href = '{% url "pagamento" %}';
                    }
                } else {
                    alert('Erro: ' + error.error);
                }
            }
        });
    });
    
    // Display download results
    function displayResults(data) {
        let html = '';
        
        if (data.type === 'track') {
            html = `
                <div class="alert alert-success">
                    <h6 class="alert-heading">${data.message}</h6>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>${data.metadata.title}</strong>
                        <a href="${data.download_url}" class="btn btn-success btn-sm">
                            <i class="fas fa-download me-1"></i>Baixar MP3
                        </a>
                    </div>
                </div>
            `;
        } else if (data.type === 'playlist') {
            html = `
                <div class="alert alert-info">
                    <h6 class="alert-heading">${data.message}</h6>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-success">${data.results.successful}</div>
                            <small>Sucessos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-danger">${data.results.failed}</div>
                            <small>Falhas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-warning">${data.results.skipped}</div>
                            <small>Puladas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-info">${data.results.total}</div>
                            <small>Total</small>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.results.downloads && data.results.downloads.length > 0) {
                html += '<hr><h6>Downloads Disponíveis:</h6>';
                data.results.downloads.forEach(download => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <strong>${download.track.title}</strong><br>
                                <small class="text-muted">${download.track.artist}</small>
                            </div>
                            <a href="{% url 'download_file' %}?file=${download.filename}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-download me-1"></i>Baixar
                            </a>
                        </div>
                    `;
                });
            }
        }
        
        $('#results-content').html(html);
        $('#download-results').removeClass('d-none');
        
        // Scroll to results
        $('html, body').animate({
            scrollTop: $('#download-results').offset().top
        }, 500);
        
        // Reload page after 3 seconds to update stats
        setTimeout(() => {
            location.reload();
        }, 3000);
    }
});
</script>
{% endblock %}